---
title: "Recommendations for R Markdown"
author: "Dominic Comtois"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: false
    toc: true
    toc_depth: 1
    css: 
    - !expr system.file("rmarkdown/templates/html_vignette/resources/vignette.css", 
                        package = "rmarkdown")
vignette: >
  %\VignetteIndexEntry{Recommendations for R Markdown}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{magrittr}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
library(knitr)
opts_chunk$set(comment = NA, 
               prompt  = FALSE,
               cache   = FALSE,
               echo    = TRUE,
               results = 'asis')
library(summarytools)
st_options(lang = "en")
```

```{r, echo=FALSE}
st_options(bootstrap.css     = FALSE,       # Already part of the theme so no need for it
           plain.ascii       = FALSE,       # One of the essential settings
           style             = "rmarkdown", # Idem.
           dfSummary.silent  = TRUE,        # Suppresses messages about temporary files
           footnote          = NA,          # Keeping the results minimalistic
           subtitle.emphasis = FALSE)       # For the vignette theme, this gives better results.
                                            # For other themes, using TRUE might be preferable.
st_css(main = TRUE, global = TRUE)
```

# 1. Introduction

This document mainly contains examples showing how best to make use of
**summarytools** in *Rmarkdown* documents. 

Available styles in _summarytools_ are directly linked to `pander`'s:  

- _simple_ (default)  
- _rmarkdown_  
- _grid_  
- _multiline_  
- _jira_  
 
For `freq()`, `descr()` (and `ctable()`, although with caveats), _rmarkdown_ 
style is recommended. For `dfSummary()`, _grid_ is recommended.
 
Starting with `freq()`, we'll review the recommended methods and styles to 
quickly get satisfying results in *Rmarkdown* documents.


## 1.1 Contents

--------------------------------------------------------------------------------

# 1. Using freq() in R Markdown

`freq()` is best used with `style = 'rmarkdown'; html rendering is also 
possible.

## 1.1 Rmarkdown Style for freq()  
```{r}
freq(tobacco$gender, style = 'rmarkdown')
```


## 1.2 HTML Rendering for freq()  
```{r}
print(freq(tobacco$gender), method = 'render')
```

If you find the table too large, you can use `table.classes = 'st-small'` - an 
example is provided further below.

--------------------------------------------------------------------------------

<a href="#top">Back to top</a>

# 2. Using ctable() in R Markdown 

## 2.1 Rmarkdown Style for ctable()  

Tables with heading spanning over 2 rows are not fully supported in markdown 
(yet), but the result is getting close to acceptable. This, however, is not
true for all themes. That is why the rendering method is preferred.

```{r}
ctable(tobacco$gender, tobacco$smoker, style = 'rmarkdown')
```

## 2.2 HTML Rendering for ctable()  

For best results, use this method.

```{r ctable_html}
print(ctable(tobacco$gender, tobacco$smoker), method = 'render')
```

--------------------------------------------------------------------------------
 
<a href="#top">Back to top</a>
 
# 3. Using descr() in R Markdown 
`descr()` is also best used with `style = 'rmarkdown'`, and HTML rendering is 
also supported.

## 3.1 Rmarkdown Style for descr()  
```{r}
descr(tobacco, style = 'rmarkdown')
```

## 3.2 HTML Rendering for descr()  

We'll use table.classes = 'st-small' to show how it affects the table's size,
compared to the `freq()` table rendered earlier.

```{r}
print(descr(tobacco), method = 'render', table.classes = 'st-small')
```
 
--------------------------------------------------------------------------------

<a href="#top">Back to top</a>

# 4. Using dfSummary() in R Markdown 

To get optimal results, whichever method you choose, it is always best to
omit at least 1, and if possible 2 columns from the output. Also, pick
carefully the value of the `graph.magnig` parameter.

## 4.1 Grid Style for dfSummary() 

Don't forget to specify `plain.ascii = FALSE` (or set it as a global
option with `st_options(plain.ascii = FALSE)`), or you won't get good results.

```{r dfs_grid, eval=FALSE}
dfSummary(tobacco, 
          style        = 'grid',
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          tmp.img.dir  = "/tmp")
```

<img src="dfSummary_md.png" width=100%/>

### 4.2 HTML Rendering for dfSummary()  

This method also works really well, and not having to 
specify the `tmp.img.dir` parameter is a plus.

```{r}
print(dfSummary(tobacco, 
                varnumbers   = FALSE, 
                valid.col    = FALSE, 
                graph.magnif = 0.75),
      method = 'render')
```

## 4.3 Managing Lengthy dfSummary() Outputs in Rmarkdown Documents

For data frames containing numerous variables, we can use the `max.tbl.height`
argument to wrap the results in a scrollable window having the specified
height, in pixels. For instance:

```{r}
print(dfSummary(tobacco, 
                varnumbers   = FALSE,
                na.col       = FALSE,
                graph.magnif = 0.75), 
      max.tbl.height = 300, method = "render")
```

#### Avoiding X11 Warnings

Some users reported getting repeated X11 warnings; those can easily be avoided
by using the following chunk expression: `{r, results="asis", warning=FALSE}`.


<a href="#top">Back to top</a>

--------------------------------------------------------------------------------


# 5. Using Other Formatting Packages  

As explained in the introductory vignette, `tb()` can be used to convert
**summarytools** objects created with `freq()` and `descr()` to simple
*tibbles* that packages specialized in table formatting will be able
to process. This is particularly helpful with `stby` objects:

```{r}
library(kableExtra)
library(magrittr)
stby(iris, iris$Species, descr, stats = "fivenum") %>%
  tb() %>%
  kable(format = "html", digits = 2) %>%
  collapse_rows(columns = 1, valign = "top")
```

Using `tb(order = 3)` flips the order of the grouping variable(s) and the
reported variable(s):
```{r}
stby(iris, iris$Species, descr, stats = "fivenum") %>%
  tb(order = 3) %>%
  kable(format = "html", digits = 2) %>%
  collapse_rows(columns = 1, valign = "top")
```

<a href="#top">Back to top</a>

--------------------------------------------------------------------------------


# 6. Including dfSummaries in PDF Documents 

Here is a recipe for including fully formatted data frame summaries in pdf
documents. There is some work involved, but following the instructions given
here should give the expected results.

There are basically two parts to this: first, you must create a preamble *tex*
file. Second, you must indicate in the YAML section of your document where to
find this file.

### Included Preamble *Tex* File

This is the \LaTeX  content that you'll need to put in your own *fig-align.tex*:

````
```
\usepackage{graphicx}
\usepackage[export]{adjustbox}
\usepackage{letltxmacro}
\LetLtxMacro{\OldIncludegraphics}{\includegraphics}
\renewcommand{\includegraphics}[2][]{\raisebox{0.5\height}%
  {\OldIncludegraphics[valign=t,#1]{#2}}}
```
````
 
The name of the file is arbitrary -- you can use whatever name you want. Its 
location is also up to you. I suggest you put it in the same location as your
*Rmd* file.

Along with the `graph.magnif` parameter for `dfSummary(), you might need to
adjust the 0.5 value used as raisebox parameter in the preamble.

### The YAML Section

Your document should start with a YAML header like this one, supposing the
preamble *tex* file is in the same location as your *Rmd* document :

```
---
title: "My PDF With Data Frame Summaries"
output: 
  pdf_document: 
    latex_engine: xelatex
    includes:
      in_header: ./fig-valign.tex
---
```

The *xelatex* engine option is not mandatory, but there are several advantages
to it. I use it systematically and recommend you do the same.

### R Code

Here is an example setup chunk:

````
```{r, message=FALSE}`r ''`  
library(summarytools)
st_options(
  plain.ascii = FALSE, 
  style = "rmarkdown",
  dfSummary.style = "grid",
  dfSummary.valid.col = FALSE,
  dfSummary.graph.magnif = .52,
  subtitle.emphasis = FALSE,
  tmp.img.dir = "/tmp"
)
```
````

And here is a chunk actually creating the summary:

````
```{r, results='asis', message=FALSE}`r ''`  
define_keywords(title.dfSummary = "Data Frame Summary in PDF Format")
dfSummary(tobacco)
```
````

### Remarks

Since we redefined the $\LaTeX$ command `includegraphics`, all images included using
`[](some-image.png)` will be impacted. In some cases this will likely be
problematic. Eventually we will find a more robust solution without such
undesired side-effects. If you are well versed in $\LaTeX$  and think you can
solve this problem, please get in touch.

--------------------------------------------------------------------------------

# 7. This Vignette's Setup  

This vignette uses theme `rmarkdown::html_vignette`. Its **yaml** section
looks like this:

```
# ---
# title: "Recommendations for Using summarytools With Rmarkdown"
# author: "Dominic Comtois"
# date: "`r Sys.Date()`"
# output: 
#   rmarkdown::html_vignette: 
#     css: 
#     - !expr system.file("rmarkdown/templates/html_vignette/resources/vignette.css", package = "rmarkdown")
# vignette: >
#   %\VignetteIndexEntry{Recommendations for Rmarkdown}
#   %\VignetteEngine{knitr::rmarkdown}
#   %\VignetteEncoding{UTF-8}
# ---
```

The following **summarytools global options** have been set. More of them can
be useful, but this is a good starting point.
```{r, eval=FALSE}
st_options(bootstrap.css     = FALSE,       # Already part of the theme 
           plain.ascii       = FALSE,       # One of the essential settings
           style             = "rmarkdown", # Idem.
           dfSummary.silent  = TRUE,        # Hides redundant messages 
           footnote          = NA,          # Keeping the results minimal
           subtitle.emphasis = FALSE)       # For the vignette theme, this
                                            # gives better results. For 
                                            # other themes, using TRUE might
                                            # be preferable.
```

Also, the following **knitr chunk options** were set this way:
```{r, eval=FALSE}
library(knitr)
opts_chunk$set(comment=NA, prompt=FALSE, cache=FALSE, echo=TRUE, results='asis')
```

Finally, **summarytools' CSS** has been included in the following manner, with
chunk option `echo = FALSE`:
```{r, eval=FALSE}
st_css(main = TRUE, global = TRUE)
```

<a href="#top">Back to top</a>

--------------------------------------------------------------------------------

# 8. Final Notes  

This is by no way a definitive guide; depending on the themes you use, 
you could find that other settings yield better results. If you are looking
to create a _Word_ or a _PDF_ document, you might want to try different
combinations of options. If you find problems with the recommended settings or
if you find better combinations, you are welcome to 
[open an issue on GitHub](https://github.com/dcomtois/summarytools/issues)
to suggest modifications or make a pull request with your own improvements to
this vignette.
